<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Family Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7fb;
      --accent: #4f46e5;
      --accent-soft: #eef2ff;
      --accent-strong: #4338ca;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
      --danger: #ef4444;
      --done-text: #9ca3af;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe, #f5f7fb 55%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 1.5rem 1rem 2.5rem;
    }

    .app {
      width: 100%;
      max-width: 1000px;
      margin: auto;
    }

    header {
      text-align: center;
      margin-bottom: 0.75rem;
    }

    header h1 {
      font-size: 1.7rem;
      margin: 0;
      letter-spacing: 0.03em;
    }

    header h1 span {
      color: var(--accent);
    }

    header p {
      margin: 0.25rem 0 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    @media (min-width: 768px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 1rem;
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.06),
        0 0 0 1px rgba(148, 163, 184, 0.18);
      padding: 1.25rem 1rem 1.1rem;
    }

    .calendar-card { flex: 1.7; }
    .tasks-card { flex: 1; max-width: 360px; }

    .helper-text {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    /* Calendar / view header */

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.4rem;
    }

    .calendar-month {
      font-weight: 600;
    }

    .calendar-nav button {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      padding: 0.3rem 0.6rem;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .calendar-tabs {
      display: flex;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
    }

    .tab-btn {
      padding: 0.25rem 0.8rem;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid var(--border-soft);
      cursor: pointer;
      font-size: 0.8rem;
    }

    .tab-btn.active {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
    }

    /* Calendar grid */

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.25rem;
      font-size: 0.78rem;
    }

    .calendar-grid.week-mode {
      grid-template-columns: 60px repeat(7, 1fr); /* time column + 7 days */
      gap: 0;
      border: 1px solid var(--border-soft);
      border-radius: 0.75rem;
      overflow: hidden;
      background: #f9fafb;
    }

    /* Month view */

    .day-name {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    .day-cell {
      border-radius: 0.6rem;
      background: #f9fafb;
      padding: 0.3rem;
      min-height: 3.6rem;
      border: 1px solid transparent;
      display: flex;
      flex-direction: column;
    }

    .day-cell.other-month { opacity: 0.3; }
    .day-cell.today { border-color: #93c5fd; }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.15rem;
    }

    .owner-badge {
      width: 0.55rem;
      height: 0.55rem;
      border-radius: 999px;
      background: transparent;
    }

    .day-tasks-inline {
      margin-top: 0.1rem;
      font-size: 0.72rem;
      display: flex;
      flex-direction: column;
      gap: 0.12rem;
      max-height: 2.8rem;
      overflow: hidden;
    }

    .day-task-inline {
      display: flex;
      gap: 0.25rem;
      align-items: baseline;
    }

    .day-task-time {
      font-weight: 600;
      font-size: 0.7rem;
      min-width: 2.2rem;
    }

    .day-task-text.done {
      text-decoration: line-through;
      color: var(--done-text);
    }

    /* Week view */

    .week-time-header {
      background: #e5e7eb;
      font-size: 0.75rem;
      padding: 0.25rem 0.35rem;
      border-bottom: 1px solid var(--border-soft);
    }

    .week-day-header {
      background: #e5e7eb;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.25rem 0.35rem;
      border-bottom: 1px solid var(--border-soft);
      border-left: 1px solid var(--border-soft);
      text-align: center;
      white-space: nowrap;
    }

    .week-day-header.today {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .week-time-cell {
      font-size: 0.75rem;
      padding: 0.25rem 0.35rem;
      border-bottom: 1px solid var(--border-soft);
      background: #f3f4f6;
      white-space: nowrap;
    }

    .week-cell {
      min-height: 2.4rem;
      padding: 0.2rem 0.25rem;
      border-bottom: 1px solid var(--border-soft);
      border-left: 1px solid var(--border-soft);
      background: #ffffff;
      font-size: 0.72rem;
    }

    .week-task {
      margin-bottom: 0.12rem;
      display: flex;
      align-items: baseline;
      gap: 0.2rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .week-task-dot {
      width: 0.4rem;
      height: 0.4rem;
      border-radius: 999px;
      flex-shrink: 0;
    }

    .week-task-text.done {
      text-decoration: line-through;
      color: var(--done-text);
    }

    /* Daily view (checklist) */

    .daily-view {
      font-size: 0.85rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      padding: 0.6rem 0.7rem;
    }

    .daily-section-title {
      font-size: 0.8rem;
      font-weight: 600;
      margin: 0 0 0.35rem;
      color: var(--text-muted);
    }

    .daily-list {
      margin: 0 0 0.5rem;
      padding: 0;
      list-style: none;
    }

    .daily-item {
      display: flex;
      align-items: flex-start;
      gap: 0.4rem;
      margin-bottom: 0.25rem;
    }

    .daily-item input[type="checkbox"] {
      margin-top: 0.15rem;
    }

    .daily-item-text {
      flex: 1;
    }

    .daily-item-text.done {
      text-decoration: line-through;
      color: var(--done-text);
    }

    .daily-item-meta {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .daily-empty {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Tasks panel */

    #task-list { padding: 0; margin: 0; list-style: none; }

    #task-list li {
      margin-bottom: 0.5rem;
      padding: 0.6rem;
      border-radius: 0.6rem;
      background: #f9fafb;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .task-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .task-title {
      font-size: 0.9rem;
      font-weight: 500;
      word-wrap: break-word;
    }

    .task-title.done {
      color: var(--done-text);
      text-decoration: line-through;
    }

    .task-buttons {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .tag {
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: #f3f4f6;
    }

    .tag.owner {
      border-color: #a5b4fc;
      background: #e0e7ff;
      color: #4338ca;
    }

    .tag.date {
      border-color: #6ee7b7;
      background: #d1fae5;
      color: #047857;
    }

    .tag.time {
      border-color: #7dd3fc;
      background: #e0f2fe;
      color: #0369a1;
    }

    .tag.freq {
      border-color: #facc15;
      background: #fef9c3;
      color: #92400e;
    }

    .tag.calendar-flag {
      border-color: #c4b5fd;
      background: #ede9fe;
      color: #5b21b6;
    }

    .task-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .status-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .delete-btn,
    .edit-btn {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .delete-btn { color: var(--danger); }
    .edit-btn { color: #4b5563; }

    /* Form */

    #task-form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.4rem;
      margin-bottom: 0.7rem;
    }

    #task-form input,
    #task-form select {
      padding: 0.45rem 0.5rem;
      border-radius: 0.55rem;
      border: 1px solid var(--border-soft);
      font-size: 0.85rem;
    }

    #task-form input:focus,
    #task-form select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .show-calendar-row {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    #add-button {
      margin-top: 0.2rem;
      padding: 0.55rem;
      border-radius: 999px;
      background: var(--accent);
      color: white;
      border: none;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
    }
  </style>
</head>

<body>
<div class="app">
  <header>
    <h1>Family <span>Hub</span></h1>
    <p>Shared calendar + baby task checklist</p>
  </header>

  <div class="layout">
    <section class="card calendar-card">
      <div class="calendar-header">
        <div class="calendar-month" id="calendar-month-label"></div>
        <div class="calendar-nav">
          <button id="prev-range">‹</button>
          <button id="next-range">›</button>
        </div>
      </div>

      <div class="calendar-tabs">
        <button class="tab-btn active" id="tab-daily">Daily</button>
        <button class="tab-btn" id="tab-week">Week</button>
        <button class="tab-btn" id="tab-month">Month</button>
      </div>

      <div class="helper-text">
        Daily = baby checklist · Week/Month = time-based calendar (only for tasks you choose to show).
      </div>

      <div id="daily-view" class="daily-view"></div>
      <div class="calendar-grid" id="calendar-grid"></div>
    </section>

    <section class="card tasks-card">
      <h2>Tasks</h2>
      <p class="helper-text">
        Add a task for a day. By default it appears only in the Daily checklist.
        Check “Show on calendar” to also show it in Week/Month.
      </p>

      <form id="task-form" onsubmit="return false;">
        <input id="task-input" placeholder="Task" />
        <input id="task-owner" placeholder="Owner (Sara)" />
        <input id="task-date" type="date" />
        <input id="task-time" type="time" />
        <select id="task-frequency">
          <option value="once">One time</option>
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
        </select>

        <label class="show-calendar-row">
          <input type="checkbox" id="task-show-calendar" />
          Show on calendar (week/month)
        </label>

        <button id="add-button" type="button">Add</button>
      </form>

      <ul id="task-list"></ul>
    </section>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, updateDoc,
    deleteDoc, doc, onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDxE4NcUZMqm4CMMJV7fD30DMCTC_BAxuY",
    authDomain: "leo2025-4c8a6.firebaseapp.com",
    projectId: "leo2025-4c8a6",
    storageBucket: "leo2025-4c8a6.firebasestorage.app",
    messagingSenderId: "17689554146",
    appId: "1:17689554146:web:30f171a704ea83ce6282bb",
    measurementId: "G-6BWXTN2ZQC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const tasksCollection = collection(db, "tasks");

  let tasks = [];
  let viewMode = "daily"; // "daily" | "week" | "month"
  let currentBaseDate = new Date();

  const monthLabel = document.getElementById("calendar-month-label");
  const grid = document.getElementById("calendar-grid");
  const dailyView = document.getElementById("daily-view");
  const tabDaily = document.getElementById("tab-daily");
  const tabWeek = document.getElementById("tab-week");
  const tabMonth = document.getElementById("tab-month");

  const ownerColors = ["#f97316","#22c55e","#3b82f6","#ec4899","#a855f7","#eab308"];
  const ownerMap = {};
  function getOwnerColor(owner = "Family") {
    const key = (owner || "Family").toLowerCase();
    if (!ownerMap[key]) {
      ownerMap[key] = ownerColors[Object.keys(ownerMap).length % ownerColors.length];
    }
    return ownerMap[key];
  }

  function formatDateKey(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function getTimeMinutes(task) {
    if (!task.startTime) return 24 * 60;
    const parts = task.startTime.split(":");
    if (parts.length !== 2) return 24 * 60;
    const h = Number(parts[0]);
    const m = Number(parts[1]);
    if (isNaN(h) || isNaN(m)) return 24 * 60;
    return h * 60 + m;
  }

  function occursOnDate(task, date) {
    if (!task.startDate) return false;
    const start = new Date(task.startDate + "T00:00:00");
    const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    if (isNaN(start)) return false;

    if (task.frequency === "daily") return d >= start;
    if (task.frequency === "weekly") {
      const diff = Math.floor((d - start) / (1000 * 60 * 60 * 24));
      return diff >= 0 && diff % 7 === 0;
    }
    if (task.frequency === "monthly") return d.getDate() === start.getDate();
    return d.toDateString() === start.toDateString();
  }

  function isDoneForDate(task, dateKey) {
    return task.status === "Done" && task.lastCompletedDate === dateKey;
  }

  function formatMonthLabel(date) {
    return date.toLocaleDateString(undefined, { month: "long", year: "numeric" });
  }

  function formatWeekLabel(start, end) {
    const s = start.toLocaleDateString(undefined, { month: "short", day: "numeric" });
    const e = end.toLocaleDateString(undefined, { month: "short", day: "numeric" });
    return `Week of ${s} – ${e}`;
  }

  function formatDailyLabel(date) {
    return date.toLocaleDateString(undefined, {
      weekday: "short",
      month: "short",
      day: "numeric",
      year: "numeric"
    });
  }

  /* ===== RENDER ROOT VIEW ===== */

  function renderView() {
    if (viewMode === "daily") {
      dailyView.style.display = "block";
      grid.style.display = "none";
      renderDailyView();
    } else {
      dailyView.style.display = "none";
      grid.style.display = "grid";
      if (viewMode === "week") {
        grid.classList.add("week-mode");
        renderWeekView();
      } else {
        grid.classList.remove("week-mode");
        renderMonthView();
      }
    }
  }

  /* ===== DAILY VIEW (CHECKLIST) ===== */

  function renderDailyView() {
    dailyView.innerHTML = "";

    const date = new Date(currentBaseDate);
    const dayKey = formatDateKey(date);
    monthLabel.textContent = formatDailyLabel(date);

    const tasksForDate = tasks
      .filter(t => occursOnDate(t, date))
      .sort((a, b) => getTimeMinutes(a) - getTimeMinutes(b));

    const pending = tasksForDate.filter(t => !isDoneForDate(t, dayKey));
    const done = tasksForDate.filter(t => isDoneForDate(t, dayKey));

    const pendingTitle = document.createElement("p");
    pendingTitle.className = "daily-section-title";
    pendingTitle.textContent = "Daily baby checklist";
    dailyView.appendChild(pendingTitle);

    const pendingList = document.createElement("ul");
    pendingList.className = "daily-list";

    if (pending.length === 0) {
      const empty = document.createElement("div");
      empty.className = "daily-empty";
      empty.textContent = "No tasks for this day yet, or everything is completed.";
      dailyView.appendChild(empty);
    } else {
      pending.forEach(t => {
        const li = document.createElement("li");
        li.className = "daily-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = false;
        cb.onchange = () => {
          const checked = cb.checked;
          const updates = { status: checked ? "Done" : "Not started" };
          if (checked) {
            updates.lastCompletedDate = dayKey;
          } else {
            updates.lastCompletedDate = "";
          }
          updateDoc(doc(db, "tasks", t.id), updates);
        };
        li.appendChild(cb);

        const wrap = document.createElement("div");
        wrap.className = "daily-item-text";

        const main = document.createElement("div");
        main.textContent = t.text || "(no description)";
        wrap.appendChild(main);

        const meta = document.createElement("div");
        meta.className = "daily-item-meta";
        const parts = [];
        if (t.owner) parts.push(t.owner);
        if (t.startTime) parts.push(t.startTime);
        if (t.showOnCalendar === false) {
          parts.push("Checklist only");
        } else {
          parts.push("On calendar");
        }
        meta.textContent = parts.join(" · ");
        wrap.appendChild(meta);

        li.appendChild(wrap);
        pendingList.appendChild(li);
      });

      dailyView.appendChild(pendingList);
    }

    const doneTitle = document.createElement("p");
    doneTitle.className = "daily-section-title";
    doneTitle.textContent = "Completed";
    dailyView.appendChild(doneTitle);

    if (done.length === 0) {
      const emptyDone = document.createElement("div");
      emptyDone.className = "daily-empty";
      emptyDone.textContent = "Nothing completed yet.";
      dailyView.appendChild(emptyDone);
    } else {
      const doneList = document.createElement("ul");
      doneList.className = "daily-list";
      done.forEach(t => {
        const li = document.createElement("li");
        li.className = "daily-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = true;
        cb.onchange = () => {
          const checked = cb.checked;
          const updates = { status: checked ? "Done" : "Not started" };
          if (checked) {
            updates.lastCompletedDate = dayKey;
          } else {
            updates.lastCompletedDate = "";
          }
          updateDoc(doc(db, "tasks", t.id), updates);
        };
        li.appendChild(cb);

        const wrap = document.createElement("div");
        wrap.className = "daily-item-text done";

        const main = document.createElement("div");
        main.textContent = t.text || "(no description)";
        wrap.appendChild(main);

        const meta = document.createElement("div");
        meta.className = "daily-item-meta";
        const parts = [];
        if (t.owner) parts.push(t.owner);
        if (t.startTime) parts.push(t.startTime);
        if (t.showOnCalendar === false) {
          parts.push("Checklist only");
        } else {
          parts.push("On calendar");
        }
        meta.textContent = parts.join(" · ");
        wrap.appendChild(meta);

        li.appendChild(wrap);
        doneList.appendChild(li);
      });
      dailyView.appendChild(doneList);
    }
  }

  /* ===== MONTH VIEW ===== */

  function renderMonthView() {
    grid.innerHTML = "";

    const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    days.forEach(d => {
      const el = document.createElement("div");
      el.className = "day-name";
      el.textContent = d;
      grid.appendChild(el);
    });

    const year = currentBaseDate.getFullYear();
    const month = currentBaseDate.getMonth();
    monthLabel.textContent = formatMonthLabel(currentBaseDate);

    const first = new Date(year, month, 1);
    const startDay = first.getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const prevMonthDays = new Date(year, month, 0).getDate();

    const cells = [];
    for (let i = 0; i < startDay; i++) {
      const d = new Date(year, month - 1, prevMonthDays - (startDay - 1 - i));
      cells.push({ date: d, other: true });
    }
    for (let day = 1; day <= daysInMonth; day++) {
      cells.push({ date: new Date(year, month, day), other: false });
    }

    const todayStr = new Date().toDateString();
    cells.forEach(c => addMonthDayCell(c.date, c.other, todayStr));
  }

  function addMonthDayCell(date, otherMonth, todayStr) {
    const cell = document.createElement("div");
    cell.className = "day-cell";
    if (otherMonth) cell.classList.add("other-month");
    if (date.toDateString() === todayStr) cell.classList.add("today");

    const header = document.createElement("div");
    header.className = "day-header";
    const daySpan = document.createElement("span");
    daySpan.textContent = date.getDate();
    const badge = document.createElement("span");
    badge.className = "owner-badge";
    header.appendChild(daySpan);
    header.appendChild(badge);
    cell.appendChild(header);

    const matches = tasks
      .filter(t => t.showOnCalendar !== false && occursOnDate(t, date))
      .sort((a, b) => getTimeMinutes(a) - getTimeMinutes(b));

    if (matches.length) {
      badge.style.background = getOwnerColor(matches[0].owner);

      const wrap = document.createElement("div");
      wrap.className = "day-tasks-inline";

      matches.slice(0, 3).forEach(t => {
        const row = document.createElement("div");
        row.className = "day-task-inline";

        const timeSpan = document.createElement("span");
        timeSpan.className = "day-task-time";
        timeSpan.textContent = t.startTime ? t.startTime : "•";
        row.appendChild(timeSpan);

        const label = document.createElement("span");
        label.className = "day-task-text";
        if (t.status === "Done") label.classList.add("done");
        label.textContent = t.text;
        row.appendChild(label);

        wrap.appendChild(row);
      });

      if (matches.length > 3) {
        const more = document.createElement("span");
        more.textContent = `+${matches.length - 3} more`;
        wrap.appendChild(more);
      }

      cell.appendChild(wrap);
    }

    grid.appendChild(cell);
  }

  /* ===== WEEK VIEW ===== */

  function renderWeekView() {
    grid.innerHTML = "";

    const base = new Date(currentBaseDate);
    const start = new Date(base);
    start.setDate(base.getDate() - base.getDay()); // Sunday
    const end = new Date(start);
    end.setDate(start.getDate() + 6);

    monthLabel.textContent = formatWeekLabel(start, end);

    const weekDates = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(start);
      d.setDate(start.getDate() + i);
      weekDates.push(d);
    }

    const todayStr = new Date().toDateString();
    const dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

    const emptyHeader = document.createElement("div");
    emptyHeader.className = "week-time-header";
    grid.appendChild(emptyHeader);

    weekDates.forEach((date, idx) => {
      const header = document.createElement("div");
      header.className = "week-day-header";
      if (date.toDateString() === todayStr) header.classList.add("today");
      header.textContent = `${dayNames[idx]} ${date.getDate()}`;
      grid.appendChild(header);
    });

    const hourRows = [{ label: "All day", value: null }];
    for (let h = 6; h <= 22; h++) {
      hourRows.push({ label: `${String(h).padStart(2, "0")}:00`, value: h });
    }

    hourRows.forEach(row => {
      const timeCell = document.createElement("div");
      timeCell.className = "week-time-cell";
      timeCell.textContent = row.label;
      grid.appendChild(timeCell);

      weekDates.forEach(date => {
        const cell = document.createElement("div");
        cell.className = "week-cell";

        const matches = tasks
          .filter(t => t.showOnCalendar !== false && occursOnDate(t, date))
          .filter(t => {
            if (row.value === null) return !t.startTime;
            if (!t.startTime) return false;
            const parts = t.startTime.split(":");
            const h = Number(parts[0]);
            return h === row.value;
          })
          .sort((a, b) => getTimeMinutes(a) - getTimeMinutes(b));

        matches.forEach(t => {
          const wrap = document.createElement("div");
          wrap.className = "week-task";

          const dot = document.createElement("div");
          dot.className = "week-task-dot";
          dot.style.background = getOwnerColor(t.owner);
          wrap.appendChild(dot);

          const label = document.createElement("span");
          label.className = "week-task-text";
          if (t.status === "Done") label.classList.add("done");
          // No time text here; time is implied by the row
          label.textContent = t.text;
          wrap.appendChild(label);

          cell.appendChild(wrap);
        });

        grid.appendChild(cell);
      });
    });
  }

  /* ===== TASK LIST (with edit + showOnCalendar info) ===== */

  function renderTaskList() {
    const list = document.getElementById("task-list");
    list.innerHTML = "";
    tasks.forEach(t => {
      const li = document.createElement("li");

      const top = document.createElement("div");
      top.className = "task-top";

      const title = document.createElement("div");
      title.className = "task-title";
      if (t.status === "Done") title.classList.add("done");
      title.textContent = t.text || "(no description)";
      top.appendChild(title);

      const btnWrap = document.createElement("div");
      btnWrap.className = "task-buttons";

      const editBtn = document.createElement("button");
      editBtn.className = "edit-btn";
      editBtn.textContent = "Edit";
      editBtn.onclick = async () => {
        const newText = prompt("Task", t.text || "");
        if (newText === null) return;

        const newOwner = prompt("Owner", t.owner || "Family");
        if (newOwner === null) return;

        const newDate = prompt("Date (YYYY-MM-DD)", t.startDate || "");
        if (newDate === null) return;

        const newTime = prompt("Time (HH:MM, optional)", t.startTime || "");
        if (newTime === null) return;

        let newFreq = prompt(
          "Frequency (once/daily/weekly/monthly)",
          t.frequency || "once"
        );
        if (newFreq === null) return;
        newFreq = newFreq.toLowerCase();
        const allowed = ["once","daily","weekly","monthly"];
        if (!allowed.includes(newFreq)) {
          alert("Frequency not recognized, keeping previous value.");
          newFreq = t.frequency || "once";
        }

        let showCalPrompt = prompt(
          "Show on calendar? (yes/no)",
          t.showOnCalendar === false ? "no" : "yes"
        );
        if (showCalPrompt === null) return;
        showCalPrompt = showCalPrompt.trim().toLowerCase();
        const showOnCalendar = (showCalPrompt === "yes" || showCalPrompt === "y");

        await updateDoc(doc(db, "tasks", t.id), {
          text: newText.trim() || "(no description)",
          owner: newOwner.trim() || "Family",
          startDate: newDate,
          startTime: newTime,
          frequency: newFreq,
          showOnCalendar
          // keep lastCompletedDate as is
        });
      };
      btnWrap.appendChild(editBtn);

      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.textContent = "✕";
      delBtn.onclick = () => deleteDoc(doc(db, "tasks", t.id));
      btnWrap.appendChild(delBtn);

      top.appendChild(btnWrap);
      li.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "task-meta";

      const ownerTag = document.createElement("span");
      ownerTag.className = "tag owner";
      ownerTag.textContent = t.owner || "Family";
      meta.appendChild(ownerTag);

      const dateTag = document.createElement("span");
      dateTag.className = "tag date";
      dateTag.textContent = t.startDate || "";
      meta.appendChild(dateTag);

      const timeTag = document.createElement("span");
      timeTag.className = "tag time";
      timeTag.textContent = t.startTime ? t.startTime : "All day / no time";
      meta.appendChild(timeTag);

      const freqTag = document.createElement("span");
      freqTag.className = "tag freq";
      freqTag.textContent =
        t.frequency === "daily" ? "Daily" :
        t.frequency === "weekly" ? "Weekly" :
        t.frequency === "monthly" ? "Monthly" : "One time";
      meta.appendChild(freqTag);

      const calTag = document.createElement("span");
      calTag.className = "tag calendar-flag";
      calTag.textContent =
        t.showOnCalendar === false ? "Checklist only" : "On calendar";
      meta.appendChild(calTag);

      if (t.lastCompletedDate) {
        const lastTag = document.createElement("span");
        lastTag.className = "tag";
        lastTag.textContent = "Last done: " + t.lastCompletedDate;
        meta.appendChild(lastTag);
      }

      li.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "task-actions";

      const statusLabel = document.createElement("span");
      statusLabel.className = "status-label";
      statusLabel.textContent = "Status:";
      actions.appendChild(statusLabel);

      const status = document.createElement("select");
      ["Not started","In progress","Done"].forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        if (t.status === s) opt.selected = true;
        status.appendChild(opt);
      });
      status.onchange = () => {
        const newStatus = status.value;
        const updates = { status: newStatus };
        if (newStatus === "Done") {
          const todayKey = formatDateKey(new Date());
          updates.lastCompletedDate = todayKey;
        } else {
          updates.lastCompletedDate = "";
        }
        updateDoc(doc(db, "tasks", t.id), updates);
      };
      actions.appendChild(status);

      li.appendChild(actions);
      list.appendChild(li);
    });
  }

  /* ===== ADD TASK ===== */

  document.getElementById("add-button").onclick = async () => {
    const text = document.getElementById("task-input").value.trim();
    const owner = document.getElementById("task-owner").value.trim();
    const date = document.getElementById("task-date").value;
    const time = document.getElementById("task-time").value;
    const freq = document.getElementById("task-frequency").value;
    const showOnCalendar = document.getElementById("task-show-calendar").checked;

    if (!text || !date) {
      alert("Please fill the task and date");
      return;
    }

    await addDoc(tasksCollection, {
      text,
      owner: owner || "Family",
      startDate: date,
      startTime: time || "",
      frequency: freq,
      status: "Not started",
      showOnCalendar,
      lastCompletedDate: ""
    });

    document.getElementById("task-input").value = "";
    document.getElementById("task-owner").value = "";
    document.getElementById("task-time").value = "";
    document.getElementById("task-show-calendar").checked = false;
  };

  /* ===== TAB HANDLERS ===== */

  function setActiveTab(mode) {
    viewMode = mode;
    tabDaily.classList.remove("active");
    tabWeek.classList.remove("active");
    tabMonth.classList.remove("active");
    if (mode === "daily") tabDaily.classList.add("active");
    if (mode === "week") tabWeek.classList.add("active");
    if (mode === "month") tabMonth.classList.add("active");
    renderView();
  }

  tabDaily.onclick = () => setActiveTab("daily");
  tabWeek.onclick = () => setActiveTab("week");
  tabMonth.onclick = () => setActiveTab("month");

  /* ===== PREV / NEXT ===== */

  document.getElementById("prev-range").onclick = () => {
    if (viewMode === "month") {
      currentBaseDate.setMonth(currentBaseDate.getMonth() - 1);
    } else if (viewMode === "week") {
      currentBaseDate.setDate(currentBaseDate.getDate() - 7);
    } else {
      currentBaseDate.setDate(currentBaseDate.getDate() - 1);
    }
    renderView();
  };

  document.getElementById("next-range").onclick = () => {
    if (viewMode === "month") {
      currentBaseDate.setMonth(currentBaseDate.getMonth() + 1);
    } else if (viewMode === "week") {
      currentBaseDate.setDate(currentBaseDate.getDate() + 7);
    } else {
      currentBaseDate.setDate(currentBaseDate.getDate() + 1);
    }
    renderView();
  };

  /* ===== FIRESTORE LIVE UPDATES ===== */

  onSnapshot(tasksCollection, snap => {
    tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderView();
    renderTaskList();
  });

  // initial
  renderView();
</script>

</body>
</html>
